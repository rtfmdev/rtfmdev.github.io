



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Devops manual, howto, cheatseet, tips and notes">
      
      
        <link rel="canonical" href="https://rtfmdev.github.io/dev-tools/nginx/">
      
      
        <meta name="author" content="Den Zalman">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
    
    
      
        <title>Nginx</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="manifest" type="application/manifest+json" href="../../manifest.webmanifest" crossorigin="use-credentials">
    
    
      <link rel="stylesheet" href="../../_extra/css/mermaid.css">
    
      <link rel="stylesheet" href="../../_extra/css/flowchart.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-XXXXXXXX-X", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#tldr" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://rtfmdev.github.io" title="RTFM for Dev and Ops" aria-label="RTFM for Dev and Ops" class="md-header-nav__button md-logo">
          
            <i class="md-icon">cloud</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              RTFM for Dev and Ops
            </span>
            <span class="md-header-nav__topic">
              
                Nginx
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://rtfmdev.github.io" title="RTFM for Dev and Ops" class="md-nav__button md-logo">
      
        <i class="md-icon">cloud</i>
      
    </a>
    RTFM for Dev and Ops
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Main page" class="md-nav__link">
      Main page
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      AWS services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        AWS services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../AWS_services/" title="AWS services" class="md-nav__link">
      AWS services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../AWS_services/fargate/" title="ECS Fargate" class="md-nav__link">
      ECS Fargate
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../AWS_services/useful-tips/" title="Useful Tips" class="md-nav__link">
      Useful Tips
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Dev tools
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Dev tools
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../git/" title="Git Tricks" class="md-nav__link">
      Git Tricks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../javascript/" title="Javascript" class="md-nav__link">
      Javascript
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../jenkins/" title="Jenkins" class="md-nav__link">
      Jenkins
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongo/" title="MongoDB" class="md-nav__link">
      MongoDB
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="Nginx" class="md-nav__link md-nav__link--active">
      Nginx
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../one-liners/" title="Bash oneliners" class="md-nav__link">
      Bash oneliners
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python/" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../terraform/" title="Terraform" class="md-nav__link">
      Terraform
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Docker
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../docker/" title="Docker tips" class="md-nav__link">
      Docker tips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../docker/commans/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Kubernetes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Kubernetes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/advanced_tools/" title="Advanced tools" class="md-nav__link">
      Advanced tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/configMaps/" title="ConfigMaps and Secrets" class="md-nav__link">
      ConfigMaps and Secrets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/helm/" title="Helm" class="md-nav__link">
      Helm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/ingress/" title="Ingress" class="md-nav__link">
      Ingress
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/kubectl/" title="kubectl cheatsheet" class="md-nav__link">
      kubectl cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/networking/" title="Networking" class="md-nav__link">
      Networking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/volume_types/" title="Volume Types" class="md-nav__link">
      Volume Types
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Linux
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Miscellaneous
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Miscellaneous
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../miscellaneous/" title="Notes" class="md-nav__link">
      Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../miscellaneous/bookshelf/" title="Bookshelf" class="md-nav__link">
      Bookshelf
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../miscellaneous/makdocs/" title="Makdocs helper" class="md-nav__link">
      Makdocs helper
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <p>===============================================
NGINX proxy pitfalls related with DNS resolving
===============================================</p>
<p>If you're using <code>proxy_pass</code> and your endpoint's IPs can vary in time, please read this article to avoid misunderstandings about how nginx works.</p>
<p>.. contents::</p>
<h1 id="tldr">TL;DR<a class="headerlink" href="#tldr" title="Permanent link">&para;</a></h1>
<p>If you want to force nginx resolve your endpoints, you should:</p>
<ul>
<li>Use variables within <code>proxy_pass</code> directive, e.g. <code>proxy_pass https://$endpoint/;</code>, where <code>$endpoint</code> can be manually setted or extracted from location regexp. <code>Read more &lt;https://github.com/DmitryFillo/nginx-proxy-pitfalls#add-variables&gt;</code>_.</li>
<li>Make sure that your endpoint isn't used in the another locations w/o variables, because in this case resolving won't work. To fix this move endpoint domain to the <code>upstream</code> or use variables in the <code>proxy_pass</code> in all locations to make resolving works. <code>Read more &lt;https://github.com/DmitryFillo/nginx-proxy-pitfalls#caveats&gt;</code>_.</li>
<li><code>You can have both resolve and non-resolve locations for same domain &lt;https://github.com/DmitryFillo/nginx-proxy-pitfalls/blob/master/README.rst#you-can-have-both-resolve-and-non-resolve-locations-for-same-domain&gt;</code>_.</li>
<li>When a variable is used in proxy_pass directive, the location header is not longer adjusted. To get around this, simply set <code>proxy_redirect</code>. <code>Read more &lt;https://github.com/DmitryFillo/nginx-proxy-pitfalls#caveats&gt;</code>_.</li>
</ul>
<p>But I recommend to read full article, because it's interesting.</p>
<h1 id="explanatory-example">Explanatory example<a class="headerlink" href="#explanatory-example" title="Permanent link">&para;</a></h1>
<p>.. code:: nginx</p>
<p>location /api/ {
      proxy_pass <a href="http://api.com/">http://api.com/</a>;
  }</p>
<p>In this case nginx will resolve api.com only once at startup (or reload). But there are some cases when your endpoint can be resolved to any IP, e.g. if you're using load balancer which doing magic failover via DNS mapping. If api.com will point to another IP your proxying will fail.</p>
<h1 id="finding-the-solution">Finding the solution<a class="headerlink" href="#finding-the-solution" title="Permanent link">&para;</a></h1>
<h2 id="add-a-resolver-directive">Add a resolver directive<a class="headerlink" href="#add-a-resolver-directive" title="Permanent link">&para;</a></h2>
<p>You can check <code>official nginx documentation &lt;http://nginx.org/en/docs/&gt;</code>_ and find <code>resolver &lt;http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver&gt;</code>_ directive:</p>
<p>.. code:: nginx</p>
<p>location /api/ {
      resolver 8.8.8.8;
      proxy_pass <a href="https://api.com/">https://api.com/</a>;
  }</p>
<p>No, it will not work. Even this will not work:</p>
<p>.. code:: nginx</p>
<p>location /api/ {
      resolver 8.8.8.8 valid=1s;
      proxy_pass <a href="https://api.com/">https://api.com/</a>;
  }</p>
<p>It's because of nginx doesn't respect <code>resolver</code> directive in this case. It will resolve api.com only at startup (or reload) by system resolver (/etc/resolv.conf), even if real TTL of A/AAAA record api.com is 1s.</p>
<h2 id="add-variables">Add variables<a class="headerlink" href="#add-variables" title="Permanent link">&para;</a></h2>
<p>You can google a bit and find that <code>nginx try to resolve proxy endpoint with variables &lt;https://trac.nginx.org/nginx/ticket/723&gt;</code><em>. Also <code>official documentation for proxy_pass directive notices this too &lt;http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass&gt;</code></em>. Hmmm, I think this should be noticed in the <code>resolver</code> description, but let's try anyway:</p>
<p>.. code:: nginx</p>
<p>location = /proxy/ {
      set <span><span class="MathJax_Preview">endpoint proxy.com;
      resolver 8.8.8.8 valid=10s;
      proxy_pass https://</span><script type="math/tex">endpoint proxy.com;
      resolver 8.8.8.8 valid=10s;
      proxy_pass https://</script></span>endpoint/;
  }</p>
<p>Works as expected, nginx will query proxy.com every 10s on particular requests. These configurations works too:</p>
<p>.. code:: nginx</p>
<p>set <span><span class="MathJax_Preview">endpoint api.com;
  location ~ ^/api/(.*)</span><script type="math/tex">endpoint api.com;
  location ~ ^/api/(.*)</script></span> {
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://<span><span class="MathJax_Preview">endpoint/</span><script type="math/tex">endpoint/</script></span>1<span><span class="MathJax_Preview">is_args</span><script type="math/tex">is_args</script></span>args;
  }</p>
<p>.. code:: nginx</p>
<p>location ~ ^/(?<dest_proxy>[\w-]+)(?:/(?<path_proxy>.*))? {
      resolver 8.8.8.8 ipv6=off valid=60s;
      proxy_pass https://<span path_proxy="path_proxy"><span class="MathJax_Preview">{dest_proxy}.example.com/</span><script type="math/tex">{dest_proxy}.example.com/</script></span><span><span class="MathJax_Preview">is_args</span><script type="math/tex">is_args</script></span>args;
  }</p>
<p>Notice that nginx will start even without <code>resolver</code> directive, but will fail with 502 at runtime, because "no resolver defined to resolve".</p>
<h2 id="caveats">Caveats<a class="headerlink" href="#caveats" title="Permanent link">&para;</a></h2>
<p>.. code:: nginx</p>
<p>location = /api_version/ {
      proxy_pass <a href="https://api.com/version/">https://api.com/version/</a>;
  }</p>
<p>location ~ ^/api/(.*)$ {
      set <span><span class="MathJax_Preview">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</span><script type="math/tex">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</script></span>endpoint/<span><span class="MathJax_Preview">1</span><script type="math/tex">1</script></span>is_args$args;
  }</p>
<p>In this case nginx will resolve api.com once at startup with system resolver and then will never do re-resolve even for /api/ requests. <em>Example with /api_version/ is just synthetic example, you can use more complex scenarios with headers set, etc.</em></p>
<p>Use variables everywhere to make it work as expected:</p>
<p>.. code:: nginx</p>
<p>location = /api_version/ {
      set <span><span class="MathJax_Preview">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</span><script type="math/tex">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</script></span>endpoint/version/;
  }</p>
<p>location ~ ^/api/(.*)$ {
      set <span><span class="MathJax_Preview">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</span><script type="math/tex">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</script></span>endpoint/<span><span class="MathJax_Preview">1</span><script type="math/tex">1</script></span>is_args$args;
  }</p>
<p>You can move <code>set</code> and <code>resolver</code> to the <code>server</code> or <code>http</code> (or use <code>include</code>) directives to avoid copy-paste (also I assume that it will increase perfomance a bit, but I haven't tested it).</p>
<p>If response from proxy contains <code>Location</code> header, as in the case of a redirect, nginx will automatically replace these values as needed. However, if variables are used in <code>proxy_pass</code>, this must be done explicitly via <code>proxy_redirect</code>:</p>
<p>.. code:: nginx</p>
<p>location = /api_version/ {
      set <span><span class="MathJax_Preview">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</span><script type="math/tex">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</script></span>endpoint/version/;
      proxy_redirect https://$endpoint/ /;
  }</p>
<p>location ~ ^/api/(.*)$ {
      set <span><span class="MathJax_Preview">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</span><script type="math/tex">endpoint api.com;
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://</script></span>endpoint/<span><span class="MathJax_Preview">1</span><script type="math/tex">1</script></span>is_args<span><span class="MathJax_Preview">args;
      proxy_redirect https://</span><script type="math/tex">args;
      proxy_redirect https://</script></span>endpoint/ /;
  }</p>
<p>Single line in <code>nginx docs &lt;http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect&gt;</code>_ that mention it:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>The default parameter is not permitted if proxy_pass is specified using variables.
</code></pre></div>
</td></tr></table>

<h1 id="upstreams">Upstreams<a class="headerlink" href="#upstreams" title="Permanent link">&para;</a></h1>
<p>If you're using nginx plus, you can use <code>resolve</code> parameter, <code>check out documentation &lt;http://nginx.org/en/docs/http/ngx_http_upstream_module.html#server&gt;</code>_. I assume that it will be efficient, because documentation says "monitors changes of the IP addresses that correspond to a domain name of the server", while solutions listed above will query DNS on the particular requests. But if you're using open source nginx, no honey is available for you. No money â€” no honey.</p>
<h2 id="you-can-have-both-resolve-and-non-resolve-locations-for-same-domain">You can have both resolve and non-resolve locations for same domain<a class="headerlink" href="#you-can-have-both-resolve-and-non-resolve-locations-for-same-domain" title="Permanent link">&para;</a></h2>
<p>.. code:: nginx</p>
<p>upstream proxy {
      server proxy.com:443;
  }</p>
<p>server {
      listen      80;
      server_name fillo.me;</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>  location = /proxy-with-resolve/ {
     set $endpoint proxy.com;
     resolver 8.8.8.8 valid=1s;
     proxy_pass https://$endpoint/;
  }

  location = /proxy-without-resolve/ {
     proxy_pass https://proxy/;
     proxy_set_header Host proxy.com;
  }
</code></pre></div>
</td></tr></table>

<p>}</p>
<p>Yes, <a href="http://fillo.me/proxy-with-resolve/">http://fillo.me/proxy-with-resolve/</a> will resolve proxy.com every 1s on particular requests, while <a href="http://fillo.me/proxy-without-resolve/">http://fillo.me/proxy-without-resolve/</a> will not resolve proxy.com (nginx will resolve proxy.com at startup/reload once). This magic works because <code>upstream</code> directive is used.</p>
<p>Another example:</p>
<p>.. code:: nginx</p>
<p>upstream api_version {
      server version.api.com:443;
  }</p>
<p>server {
      listen      80;
      server_name fillo.me;</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>  location = /api_version/ {
     proxy_pass https://api_version/version/;
     proxy_set_header Host version.api.com;
  }

  location ~ ^/api/(?&lt;dest_proxy&gt;[\w-]+)(?:/(?&lt;path_proxy&gt;.*))? {
      resolver 8.8.8.8 valid=60s;
      proxy_pass https://${dest_proxy}.api.com/${path_proxy}$is_args$args;
  }
</code></pre></div>
</td></tr></table>

<p>}</p>
<ul>
<li>If you will open <a href="http://fillo.me/api_version/">http://fillo.me/api_version/</a> then no resolve will be done, because of nginx resolved version.api.com at startup.</li>
<li>If you will open <a href="http://fillo.me/api/version/version/">http://fillo.me/api/version/version/</a> then it will work as expected, nginx will resolve version.api.com every 60s on particular request.</li>
<li>If you will open <a href="http://fillo.me/api/checkout/items/">http://fillo.me/api/checkout/items/</a> then it will work as expected, nginx will resolve checkout.api.com every 60s on particular request.</li>
</ul>
<h1 id="tested-on">Tested on<a class="headerlink" href="#tested-on" title="Permanent link">&para;</a></h1>
<ul>
<li>1.9.6</li>
<li>1.10.1</li>
</ul>
<p>Although I think it works for many other versions.</p>
<h1 id="further-research">Further research<a class="headerlink" href="#further-research" title="Permanent link">&para;</a></h1>
<ul>
<li><code>This issue &lt;https://trac.nginx.org/nginx/ticket/723&gt;</code>_ says that changing HTTPS to the HTTP helps. Check how protocol changes affects examples above.</li>
<li>Compare perfomance with and without resolving.</li>
<li>Compare perfomance with different variables scopes.</li>
<li>How to force upstream resolving.</li>
</ul>
                
                  
                
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://rtfmdev.github.io/dev-tools/nginx/";
      this.page.identifier =
        "/dev-tools/nginx/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//rtfmdev.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../mongo/" title="MongoDB" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                MongoDB
              </span>
            </div>
          </a>
        
        
          <a href="../one-liners/" title="Bash oneliners" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Bash oneliners
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Den Zalman
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/denzalman" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/photofiles" target="_blank" rel="noopener" title="twitter" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/denis-salmanov" target="_blank" rel="noopener" title="linkedin" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.df00da5d.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../_extra/js/mermaid.min.js"></script>
      
        <script src="../../_extra/js/mermaid.init.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>